# 服务号模板消息配置说明

## 一、Nacos 配置

在 Nacos 配置中心的 `guanghengzou-admin-prod.yaml` 中添加以下配置：

```yaml
wechat:
  app-id: wx204f4d9d2f827c47  # 小程序 appId
  app-secret: eae0884b158ed97859f1417d5f1e6c78
  service-account:
    app-id: wx1a50ff2437f78aa6  # 服务号 appId
    app-secret: 2f9daa8087ad80411994bca4cb239185
    token: guanghengzou  # 用于微信服务器验证，需要在服务号后台配置相同的值
    template:
      new-order: 2hWD-C9qExf9bY_GeWL6EcnSw2UH9HNLHEv-0j3njUQ  # 新订单通知
      sale-approval: e4kW0-RBlIMTd7fUkv8WlCJNjcfeqD6jz-N3QPJ8dJg  # 销售单审核结果通知
      stock-out: OIt2GG_KJbknV0V1hA5EKcm05H_iFgjnnNkSGAIVIEE  # 出库单审核结果通知
      sale-recharge: iJ8oCPZKgdy8SF-SxCdBWpesV7lvDqptEHLFPFb_2XY  # 退款申请通知

# 后台管理URL（用于模板消息跳转）
admin:
  web:
    url: https://admin.guanghengzou.com
```

## 二、模板消息说明

### 1. 新订单通知 (new-order)
- 模板ID: `2hWD-C9qExf9bY_GeWL6EcnSw2UH9HNLHEv-0j3njUQ`
- 触发时机: 小程序有新订单支付成功时
- 通知对象: 所有管理员账号 + 订单对应发货门店的店长账号
- 模板字段:
  - `character_string2`: 订单号
  - `thing3`: 订单类型
  - `amount5`: 订单金额
  - `time6`: 下单时间
  - `thing4`: 商品名称

### 2. 销售单审核结果通知 (sale-approval)
- 模板ID: `e4kW0-RBlIMTd7fUkv8WlCJNjcfeqD6jz-N3QPJ8dJg`
- 触发时机:
  - 新销售单申请时 → 通知管理员
  - 管理员通过/驳回时 → 通知申请账号
- 模板字段:
  - `time1`: 审核时间
  - `character_string3`: 审核单号
  - `const2`: 审核结果（待审核/通过/驳回）

### 3. 出库单审核结果通知 (stock-out)
- 模板ID: `OIt2GG_KJbknV0V1hA5EKcm05H_iFgjnnNkSGAIVIEE`
- 触发时机:
  - 新调货申请时 → 通知管理员 + 被申请调货的门店账号
  - 确认发货后 → 通知申请门店账号
  - 确认收货后 → 通知被申请调货的门店账号
- 模板字段:
  - `character_string1`: 出库单号
  - `time5`: 审核时间
  - `thing2`: 客户名称

### 4. 退款申请通知 (sale-recharge)
- 模板ID: `iJ8oCPZKgdy8SF-SxCdBWpesV7lvDqptEHLFPFb_2XY`
- 触发时机: 有新的退款申请时
- 通知对象: 所有管理员账号
- 模板字段:
  - `character_string2`: 订单号
  - `thing3`: 商品名称
  - `amount4`: 退款金额
  - `time5`: 申请时间
  - `phone_number6`: 联系电话

## 三、账号类型说明

`ums_admin` 表中的账号类型字段：
- `admin_type = 0`: 管理账号（可查看所有门店）
- `admin_type = 1`: 门店账号（只能查看关联门店）

微信绑定字段：
- `wx_service_openid`: 服务号 OpenID（用于发送模板消息）
- `wx_service_nickname`: 微信昵称
- `wx_service_headimg`: 微信头像
- `wx_service_bindtime`: 绑定时间

## 四、通知策略

1. 优先使用模板消息发送
2. 模板消息发送失败时，降级到客服消息
3. 客服消息有48小时互动限制，超时则发送失败
4. 通知发送失败不影响主业务流程

## 五、服务号后台配置

1. 登录微信公众平台 (mp.weixin.qq.com)
2. 进入「设置与开发」→「基本配置」
3. 配置服务器地址（URL）、Token、EncodingAESKey
4. 确保 Token 与 Nacos 配置中的 `wechat.service-account.token` 一致
