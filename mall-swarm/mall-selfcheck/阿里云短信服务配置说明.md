# 阿里云短信服务配置说明

## 📱 概述

Mall自助收银系统已集成阿里云短信服务，用于发送手机验证码。本文档详细说明配置方法和使用规范。

## 🔧 配置信息

### 当前生产配置
```yaml
selfcheck:
  sms:
    provider: aliyun                    # 使用阿里云短信服务
    aliyun:
      accessKeyId: ${ALIYUN_SMS_ACCESS_KEY_ID}
      accessKeySecret: ${ALIYUN_SMS_ACCESS_KEY_SECRET}
      signName: ${ALIYUN_SMS_SIGN_NAME}                # 短信签名
      templateCode: ${ALIYUN_SMS_TEMPLATE_CODE}       # 短信模板代码
      region: cn-hangzhou              # 阿里云区域
```

### 短信模板内容
- **模板代码**: 在阿里云控制台申请
- **模板内容**: `您的验证码是${code}，有效期5分钟，请勿泄露给他人。`
- **签名**: 在阿里云控制台申请

## 🚀 功能特性

### 1. 智能安全控制
- ✅ **频率限制**: 同一手机号60秒内只能发送一次
- ✅ **IP保护**: 检测恶意IP，自动锁定异常行为
- ✅ **参数验证**: 严格验证手机号格式
- ✅ **有效期控制**: 验证码5分钟内有效

### 2. 多环境支持
```yaml
# 开发环境（使用模拟模式）
selfcheck:
  sms:
    provider: mock
    mock:
      enabled: true
      fixedCode: "123456"

# 生产环境（使用阿里云）
selfcheck:
  sms:
    provider: aliyun
    aliyun:
      accessKeyId: ${ALIYUN_SMS_ACCESS_KEY_ID}
      accessKeySecret: ${ALIYUN_SMS_ACCESS_KEY_SECRET}
      signName: ${ALIYUN_SMS_SIGN_NAME}
      templateCode: ${ALIYUN_SMS_TEMPLATE_CODE}
```

### 3. 容错机制
- 🔄 **自动重试**: 发送失败时自动重试
- 📊 **状态监控**: 详细的发送日志和状态记录
- ⚠️ **异常处理**: 完善的错误处理和用户友好提示

## 📋 API使用

### 发送验证码接口
```http
POST /member/sendVerifyCode
Content-Type: application/x-www-form-urlencoded

telephone=13800138001
```

### 响应格式
```json
{
    "code": 200,
    "message": "验证码发送成功",
    "data": {
        "message": "验证码发送成功",
        "codeLength": 6,
        "expireTime": 300,
        "canResendAfter": 60
    }
}
```

## 🔒 安全配置

### 当前安全策略
```yaml
selfcheck:
  member:
    verifyCodeExpire: 5          # 验证码有效期（分钟）
    sendRateLimit: 60           # 发送频率限制（秒）
  
  security:
    maxLoginAttempts: 5         # 最大登录尝试次数
    loginLockDuration: 900      # 登录锁定时长（秒）
    ipBlockDuration: 3600       # IP锁定时长（秒）
    rateLimitWindow: 300        # 频率限制窗口（秒）
    maxAttemptsPerWindow: 3     # 窗口内最大尝试次数
```

### IP安全机制
- 5分钟内失败超过10次自动锁定IP
- 锁定时长: 1小时
- 异常行为检测和告警

## 🧪 测试方法

### 1. 使用测试脚本
```powershell
# 运行测试脚本
./test-aliyun-sms.ps1
```

### 2. 手动测试
```powershell
# 使用PowerShell发送请求
$body = "telephone=13800138001"
$headers = @{'Content-Type' = 'application/x-www-form-urlencoded'}
$response = Invoke-RestMethod -Uri "http://localhost:8201/mall-selfcheck/member/sendVerifyCode" -Method POST -Body $body -Headers $headers
Write-Host $response
```

### 3. 前端集成测试
前端已自动适配新的参数格式，使用表单参数而非JSON格式。

## 📊 监控和日志

### 日志记录
- ✅ 发送成功: 记录手机号、验证码、RequestId
- ❌ 发送失败: 记录错误代码、错误信息
- 🚫  安全拦截: 记录IP、拦截原因
- 📈 频率限制: 记录限制触发情况

### 监控指标
- 验证码发送成功率
- 平均响应时间
- 每日发送量统计
- 异常IP统计

## 🔄 版本更新记录

### v1.0.0 (当前版本)
- ✅ 集成阿里云短信SDK 3.1.0
- ✅ 支持验证码发送和验证
- ✅ 完善的安全控制机制
- ✅ 多环境配置支持
- ✅ 详细的日志记录

## 📞 故障排查

### 常见问题

#### 1. 短信发送失败
**可能原因**:
- AccessKey配置错误
- 短信签名未审核通过
- 短信模板未审核通过
- 账户余额不足

**解决方法**:
- 检查阿里云控制台配置
- 确认签名和模板状态
- 充值账户余额

#### 2. 验证码收不到
**可能原因**:
- 手机号格式错误
- 网络延迟
- 运营商拦截

**解决方法**:
- 检查手机号格式
- 等待1-2分钟
- 使用其他手机号测试

#### 3. 频率限制
**现象**: "发送过于频繁"错误
**解决**: 等待60秒后重试

## 🎯 最佳实践

### 1. 生产环境安全
- 使用环境变量存储敏感配置
- 定期轮换AccessKey
- 监控发送量和成本

### 2. 性能优化
- 合理设置频率限制
- 监控Redis性能
- 定期清理过期数据

### 3. 用户体验
- 提供清晰的错误提示
- 显示倒计时避免重复点击
- 支持语音验证码备选方案

## 📞 联系支持

如有问题，请联系技术支持：
- 📧 邮箱: tech-support@company.com
- 📱 电话: 400-xxx-xxxx
- 💬 企微: @技术支持群 
