# Mall 自助收银系统 - 前端集成指南

## 概述

本文档指导如何将 `mall-self-checkout` 前端应用与 `mall-selfcheck` 后端服务集成。

## 系统架构

```
┌─────────────────────┐    HTTP API    ┌─────────────────────┐
│                     │ ←──────────→   │                     │
│  mall-self-checkout │                │   mall-selfcheck    │
│   (Electron/Vue3)   │                │   (Spring Boot)     │
│                     │                │                     │
└─────────────────────┘                └─────────────────────┘
        │                                        │
        ▼                                        ▼
┌─────────────────────┐                ┌─────────────────────┐
│     前端组件         │                │     后端服务         │
│                     │                │                     │
│ • 扫码组件          │                │ • 会员认证服务       │
│ • 支付组件          │                │ • 商品管理服务       │
│ • 购物车组件        │                │ • 购物车服务         │
│ • 订单组件          │                │ • 订单管理服务       │
│ • 会员组件          │                │ • 支付服务           │
└─────────────────────┘                └─────────────────────┘
```

## 集成步骤

### 1. 前端项目配置

#### 1.1 安装依赖

```bash
cd mall-self-checkout
npm install
```

#### 1.2 环境配置

创建或修改环境配置文件：

```typescript
// src/config/env.ts
export const appConfig = {
  apiBaseUrl: 'http://localhost:8084',
  apiTimeout: 30000,
  terminalCode: 'SC001',
  deviceType: 'WINDOWS',
  paymentMock: true,
  debugMode: true
}
```

#### 1.3 API 模块集成

前端 API 模块已创建：
- `src/renderer/api/modules/payment.ts` - 支付相关 API
- `src/renderer/api/modules/member.ts` - 会员相关 API
- `src/renderer/api/modules/product.ts` - 商品相关 API

### 2. 后端服务启动

#### 2.1 启动 mall-selfcheck 服务

```bash
cd mall-swarm/mall-selfcheck
mvn spring-boot:run -Dspring-boot.run.profiles=dev
```

服务将在 `http://localhost:8084` 启动

#### 2.2 验证服务状态

```bash
# 健康检查
curl http://localhost:8084/selfcheck/test/health

# 服务信息
curl http://localhost:8084/selfcheck/test/info
```

### 3. 核心功能集成

#### 3.1 会员认证流程

```typescript
// 前端示例代码
import { guestLogin, memberLogin, sendVerifyCode } from '@/api/modules/member'

// 游客登录
const handleGuestLogin = async () => {
  try {
    const result = await guestLogin({
      deviceId: 'DEVICE_001',
      deviceType: 'WINDOWS'
    })
    console.log('游客登录成功:', result)
    // 存储 token 和会话信息
    localStorage.setItem('access_token', result.token)
  } catch (error) {
    console.error('游客登录失败:', error)
  }
}

// 发送验证码
const handleSendCode = async (phone: string) => {
  try {
    await sendVerifyCode(phone)
    console.log('验证码发送成功')
  } catch (error) {
    console.error('验证码发送失败:', error)
  }
}

// 会员登录
const handleMemberLogin = async (phone: string, code: string) => {
  try {
    const result = await memberLogin({ telephone: phone, verifyCode: code })
    console.log('会员登录成功:', result)
    // 存储 token 和会员信息
    localStorage.setItem('access_token', result.token)
  } catch (error) {
    console.error('会员登录失败:', error)
  }
}
```

#### 3.2 商品扫码流程

```typescript
import { scanProduct, quickScan } from '@/api/modules/product'

// 扫码查询商品
const handleScanProduct = async (barcode: string) => {
  try {
    const product = await scanProduct({
      barcode,
      needStockCheck: true,
      needPromotionInfo: true
    })
    console.log('商品信息:', product)
    return product
  } catch (error) {
    console.error('商品扫码失败:', error)
    throw error
  }
}

// 快速扫码
const handleQuickScan = async (barcode: string) => {
  try {
    const product = await quickScan(barcode)
    console.log('快速扫码结果:', product)
    return product
  } catch (error) {
    console.error('快速扫码失败:', error)
    throw error
  }
}
```

#### 3.3 支付流程

```typescript
import { 
  generatePaymentQR, 
  scanPaymentCode, 
  getPaymentStatus,
  validatePaymentCode 
} from '@/api/modules/payment'

// 生成收款二维码
const handleGenerateQR = async (orderId: number, amount: number) => {
  try {
    const result = await generatePaymentQR({
      orderId,
      amount,
      payType: 'WECHAT',
      title: '购物付款',
      terminalCode: 'SC001'
    })
    console.log('收款二维码:', result)
    return result
  } catch (error) {
    console.error('生成收款二维码失败:', error)
    throw error
  }
}

// 扫码支付
const handleScanPayment = async (orderId: number, paymentCode: string, amount: number) => {
  try {
    // 先验证付款码
    const payType = await validatePaymentCode(paymentCode)
    
    // 执行支付
    const result = await scanPaymentCode({
      orderId,
      paymentCode,
      amount,
      payType: payType === '微信支付' ? 'WECHAT' : 'ALIPAY',
      terminalCode: 'SC001'
    })
    
    console.log('支付结果:', result)
    return result
  } catch (error) {
    console.error('扫码支付失败:', error)
    throw error
  }
}

// 轮询支付状态
const pollPaymentStatus = async (paymentId: string) => {
  const pollInterval = setInterval(async () => {
    try {
      const status = await getPaymentStatus(paymentId)
      console.log('支付状态:', status)
      
      if (status.payStatus === 'SUCCESS' || status.payStatus === 'FAILED') {
        clearInterval(pollInterval)
        // 处理支付结果
        handlePaymentResult(status)
      }
    } catch (error) {
      console.error('查询支付状态失败:', error)
    }
  }, 2000)
  
  // 5分钟后停止轮询
  setTimeout(() => clearInterval(pollInterval), 300000)
}
```

### 4. 前端页面组件

#### 4.1 登录页面集成

```vue
<!-- src/renderer/views/login/LoginPage.vue -->
<template>
  <div class="login-page">
    <div class="login-options">
      <button @click="handleGuestLogin" class="guest-login-btn">
        游客购物
      </button>
      
      <div class="member-login">
        <input 
          v-model="phone" 
          placeholder="请输入手机号"
          type="tel"
        />
        <button @click="sendCode" :disabled="codeLoading">
          {{ codeLoading ? '发送中...' : '发送验证码' }}
        </button>
        <input 
          v-model="verifyCode" 
          placeholder="请输入验证码"
          maxlength="6"
        />
        <button @click="memberLogin" :disabled="loginLoading">
          {{ loginLoading ? '登录中...' : '会员登录' }}
        </button>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { useRouter } from 'vue-router'
import { guestLogin, memberLogin as apiMemberLogin, sendVerifyCode } from '@/api/modules'

const router = useRouter()
const phone = ref('')
const verifyCode = ref('')
const codeLoading = ref(false)
const loginLoading = ref(false)

const handleGuestLogin = async () => {
  try {
    const result = await guestLogin()
    localStorage.setItem('access_token', result.token)
    localStorage.setItem('user_type', 'guest')
    router.push('/scan')
  } catch (error) {
    console.error('游客登录失败:', error)
  }
}

const sendCode = async () => {
  if (!phone.value) return
  
  codeLoading.value = true
  try {
    await sendVerifyCode(phone.value)
    // 显示发送成功提示
  } catch (error) {
    console.error('发送验证码失败:', error)
  } finally {
    codeLoading.value = false
  }
}

const memberLogin = async () => {
  if (!phone.value || !verifyCode.value) return
  
  loginLoading.value = true
  try {
    const result = await apiMemberLogin({
      telephone: phone.value,
      verifyCode: verifyCode.value
    })
    localStorage.setItem('access_token', result.token)
    localStorage.setItem('user_type', 'member')
    router.push('/scan')
  } catch (error) {
    console.error('会员登录失败:', error)
  } finally {
    loginLoading.value = false
  }
}
</script>
```

#### 4.2 扫码购物页面

```vue
<!-- src/renderer/views/scan/ScanPage.vue -->
<template>
  <div class="scan-page">
    <div class="scanner-container">
      <BarcodeScanner 
        @scan-success="handleScanSuccess"
        @scan-error="handleScanError"
      />
    </div>
    
    <div class="product-info" v-if="currentProduct">
      <ProductCard :product="currentProduct" />
      <div class="actions">
        <button @click="addToCart" :disabled="addingToCart">
          {{ addingToCart ? '添加中...' : '加入购物车' }}
        </button>
      </div>
    </div>
    
    <div class="cart-summary">
      <router-link to="/cart" class="cart-link">
        购物车 ({{ cartCount }})
      </router-link>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { scanProduct } from '@/api/modules/product'
import { addCartItem } from '@/api/modules/cart'
import BarcodeScanner from '@/components/common/Scanner/BarcodeScanner.vue'
import ProductCard from '@/components/business/ProductCard/ProductCard.vue'

const currentProduct = ref(null)
const cartCount = ref(0)
const addingToCart = ref(false)

const handleScanSuccess = async (result) => {
  try {
    const product = await scanProduct({
      barcode: result.text,
      needStockCheck: true,
      needPromotionInfo: true
    })
    currentProduct.value = product
  } catch (error) {
    console.error('商品查询失败:', error)
    // 显示错误提示
  }
}

const handleScanError = (error) => {
  console.error('扫码失败:', error)
  // 显示错误提示
}

const addToCart = async () => {
  if (!currentProduct.value) return
  
  addingToCart.value = true
  try {
    await addCartItem({
      productId: currentProduct.value.productId,
      skuId: currentProduct.value.skuId,
      quantity: 1
    })
    cartCount.value++
    // 显示添加成功提示
  } catch (error) {
    console.error('添加购物车失败:', error)
  } finally {
    addingToCart.value = false
  }
}
</script>
```

### 5. 测试和调试

#### 5.1 运行测试脚本

```bash
# 在 mall-swarm/mall-selfcheck 目录下运行
./test-api.bat
```

#### 5.2 前端调试

1. 确保后端服务运行在 `http://localhost:8084`
2. 启动前端开发服务器
3. 打开浏览器开发者工具查看网络请求
4. 检查 API 调用和响应数据

#### 5.3 常见问题排查

**问题1: 跨域请求被阻止**
```typescript
// 在 vite.config.ts 中配置代理
export default defineConfig({
  server: {
    proxy: {
      '/selfcheck': {
        target: 'http://localhost:8084',
        changeOrigin: true
      }
    }
  }
})
```

**问题2: 认证失败**
```typescript
// 检查 token 是否正确设置
const token = localStorage.getItem('access_token')
if (!token) {
  router.push('/login')
}
```

**问题3: API 请求超时**
```typescript
// 增加请求超时时间
export const API_CONFIG = {
  TIMEOUT: 60000 // 60秒
}
```

### 6. 部署配置

#### 6.1 生产环境配置

```typescript
// src/config/env.ts
export const createAppConfig = (): AppConfig => {
  return {
    // 生产环境使用实际的API地址
    apiBaseUrl: process.env.NODE_ENV === 'production' 
      ? 'https://api.yourdomain.com' 
      : 'http://localhost:8084',
    
    // 生产环境关闭mock模式
    paymentMock: process.env.NODE_ENV !== 'production',
    debugMode: process.env.NODE_ENV !== 'production'
  }
}
```

#### 6.2 构建和打包

```bash
# 构建 Electron 应用
npm run build:electron

# 构建 Android 应用
npm run build:android
```

### 7. 下一步建议

1. **功能完善**
   - 实现完整的购物流程
   - 添加错误处理和用户反馈
   - 优化用户体验

2. **支付集成**
   - 配置真实的微信/支付宝支付参数
   - 测试真实支付流程
   - 处理支付回调

3. **性能优化**
   - 实现组件懒加载
   - 优化API请求
   - 添加缓存机制

4. **测试**
   - 编写单元测试
   - 进行集成测试
   - 用户体验测试

5. **部署**
   - 配置生产环境
   - 设置CI/CD流程
   - 监控和日志

## 技术支持

如遇到集成问题，请检查：

1. 后端服务是否正常运行
2. 网络连接是否正常
3. API地址配置是否正确
4. 认证token是否有效
5. 查看浏览器控制台错误信息

更多技术细节请参考项目文档和API测试文件。 