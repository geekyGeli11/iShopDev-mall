# 优惠券功能扩展 - 端到端功能测试

## 测试环境配置

### 1. 启动服务
```bash
# 启动必要的服务
cd mall-swarm
mvn spring-boot:run -pl mall-admin
mvn spring-boot:run -pl mall-portal
```

### 2. 数据库准备
执行以下SQL脚本：
- `coupon_enhancement_ddl.sql` - 数据库结构更新
- `coupon_data_migration.sql` - 数据迁移和测试数据

## 端到端测试流程

### 测试场景1：管理员创建打折券
**目标**：验证管理员可以成功创建打折券

**步骤**：
1. 登录管理后台
2. 进入优惠券管理页面
3. 点击"添加优惠券"
4. 填写打折券信息：
   - 优惠券名称：全场8折优惠券
   - 优惠方式：打折券
   - 折扣率：0.8
   - 使用门槛：50元
   - 可使用商品：全场通用
   - 排除逻辑：不启用
5. 保存优惠券

**预期结果**：
- 优惠券创建成功
- 列表页显示"打折券"类型
- 优惠信息显示"8折"

### 测试场景2：管理员创建带排除逻辑的满减券
**目标**：验证复杂的排除逻辑配置

**步骤**：
1. 创建满减券：
   - 优惠券名称：服装类满100减20（排除特定商品）
   - 优惠方式：满减券
   - 面额：20元
   - 使用门槛：100元
   - 可使用商品：指定分类（服装）
   - 排除逻辑：启用
2. 配置可用分类：选择"服装"分类
3. 配置排除商品：选择特定商品
4. 保存优惠券

**预期结果**：
- 优惠券创建成功
- 排除逻辑配置正确保存
- 适用性检查API返回正确结果

### 测试场景3：用户端获取可用优惠券
**目标**：验证用户端优惠券列表的正确性

**步骤**：
1. 用户登录
2. 添加商品到购物车（包含服装类商品）
3. 进入购物车页面
4. 查看可用优惠券列表

**预期结果**：
- 显示适用的优惠券
- 排除逻辑正确生效
- 打折券和满减券都正确显示

### 测试场景4：使用打折券下单
**目标**：验证打折券的优惠金额计算

**步骤**：
1. 选择打折券
2. 确认订单信息
3. 检查优惠金额计算
4. 提交订单

**预期结果**：
- 优惠金额 = 商品金额 × (1 - 0.8) = 商品金额 × 0.2
- 订单总金额正确
- 订单详情显示打折券信息

### 测试场景5：使用满减券下单
**目标**：验证满减券的优惠金额计算

**步骤**：
1. 选择满减券
2. 确认订单信息
3. 检查优惠金额计算
4. 提交订单

**预期结果**：
- 优惠金额 = 20元（固定金额）
- 订单总金额正确
- 订单详情显示满减券信息

## API接口测试

### 1. 优惠券创建接口测试
```bash
curl -X POST "http://localhost:8080/admin/coupon/create" \
-H "Content-Type: application/json" \
-d '{
  "name": "API测试打折券",
  "type": 0,
  "couponType": 1,
  "discountRate": 0.9,
  "minPoint": 100.00,
  "useType": 0,
  "enableExclude": false,
  "publishCount": 100,
  "perLimit": 1,
  "startTime": "2025-09-01 00:00:00",
  "endTime": "2025-12-31 23:59:59"
}'
```

### 2. 适用性检查接口测试
```bash
curl "http://localhost:8080/admin/coupon/checkApplicability/1?productId=101&productCategoryId=1"
```

### 3. 优惠金额计算接口测试
```bash
curl "http://localhost:8080/admin/coupon/calculateDiscount/1?orderAmount=100.00"
```

### 4. 用户端优惠券列表测试
```bash
curl "http://localhost:8080/portal/member/coupon/list/cart?type=1" \
-H "Authorization: Bearer {token}"
```

## 性能测试

### 1. 大量优惠券查询性能
创建1000个优惠券，测试列表查询性能：
```sql
-- 批量创建测试数据
INSERT INTO sms_coupon (name, type, coupon_type, amount, discount_rate, ...)
SELECT 
    CONCAT('性能测试券_', @row_number := @row_number + 1),
    0, 0, 10.00, NULL, ...
FROM 
    (SELECT @row_number := 0) r,
    information_schema.tables 
LIMIT 1000;
```

### 2. 复杂排除逻辑性能
测试包含大量排除关系的优惠券适用性检查性能。

### 3. 并发创建优惠券
使用JMeter或类似工具测试并发创建优惠券的稳定性。

## 兼容性测试

### 1. 现有数据兼容性
- 验证现有优惠券数据正常显示
- 验证现有API调用不受影响
- 验证数据迁移后功能正常

### 2. 前端兼容性
- 验证新界面在不同浏览器中正常显示
- 验证移动端界面适配
- 验证表单验证逻辑

### 3. API版本兼容性
- 验证旧版本客户端调用正常
- 验证新字段的默认值处理
- 验证错误处理机制

## 测试结果记录

### 功能测试结果
- [ ] 测试场景1：管理员创建打折券 - ✅通过 / ❌失败
- [ ] 测试场景2：创建带排除逻辑的满减券 - ✅通过 / ❌失败
- [ ] 测试场景3：用户端获取可用优惠券 - ✅通过 / ❌失败
- [ ] 测试场景4：使用打折券下单 - ✅通过 / ❌失败
- [ ] 测试场景5：使用满减券下单 - ✅通过 / ❌失败

### API接口测试结果
- [ ] 优惠券创建接口 - ✅通过 / ❌失败
- [ ] 适用性检查接口 - ✅通过 / ❌失败
- [ ] 优惠金额计算接口 - ✅通过 / ❌失败
- [ ] 用户端优惠券列表 - ✅通过 / ❌失败

### 性能测试结果
- [ ] 大量优惠券查询性能 - 响应时间: ___ms
- [ ] 复杂排除逻辑性能 - 响应时间: ___ms
- [ ] 并发创建优惠券 - 成功率: ___%

### 兼容性测试结果
- [ ] 现有数据兼容性 - ✅通过 / ❌失败
- [ ] 前端兼容性 - ✅通过 / ❌失败
- [ ] API版本兼容性 - ✅通过 / ❌失败

## 问题记录

### 发现的问题
1. **问题描述**：
   - 重现步骤：
   - 预期结果：
   - 实际结果：
   - 解决方案：

2. **问题描述**：
   - 重现步骤：
   - 预期结果：
   - 实际结果：
   - 解决方案：

### 优化建议
1. 
2. 
3. 

## 测试总结

### 整体评估
- 功能完整性：___/5
- 性能表现：___/5
- 用户体验：___/5
- 代码质量：___/5
- 兼容性：___/5

### 发布建议
- [ ] 建议发布到生产环境
- [ ] 需要修复问题后再发布
- [ ] 需要进一步测试

### 后续工作
1. 
2. 
3. 
