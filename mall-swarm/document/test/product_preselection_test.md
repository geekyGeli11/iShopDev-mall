# 商品预选功能测试指南

## 问题描述

在优惠券管理界面中，商品选择对话框的预选功能存在问题：
- 第一次选择商品后确认，再次打开对话框时，之前选择的商品没有被预选
- 用户需要重新选择已经选过的商品，体验不佳

## 修复内容

### 1. 数据类型一致性修复
确保传递给ProductSelectionDialog组件的商品ID类型与组件内部处理的ID类型一致。

### 2. 数据结构完整性修复
确保传递的商品数据包含组件所需的所有字段。

### 3. 调试信息添加
添加控制台日志来帮助排查预选问题。

## 测试步骤

### 测试1：基本预选功能

#### 步骤：
1. 进入优惠券创建页面
2. 设置使用类型为"指定商品"
3. 点击"选择商品"按钮
4. 在对话框中选择2-3个商品
5. 点击"确定"按钮
6. 验证商品是否显示在表格中
7. 再次点击"选择商品"按钮
8. **关键验证**：检查之前选择的商品是否在对话框中被预选（勾选状态）

#### 预期结果：
- ✅ 第一次选择的商品应该在表格中正确显示
- ✅ 再次打开对话框时，之前选择的商品应该被预选（有勾选标记）
- ✅ 可以在已选基础上继续添加或移除商品

### 测试2：排除商品预选功能

#### 步骤：
1. 启用"排除逻辑"开关
2. 点击"选择排除商品"按钮
3. 在对话框中选择2-3个商品
4. 点击"确定"按钮
5. 验证排除商品是否显示在表格中
6. 再次点击"选择排除商品"按钮
7. **关键验证**：检查之前选择的排除商品是否在对话框中被预选

#### 预期结果：
- ✅ 排除商品的预选功能应该与可用商品一致
- ✅ 再次打开对话框时能正确预选之前的排除商品

### 测试3：混合操作测试

#### 步骤：
1. 选择一些可用商品
2. 选择一些排除商品
3. 分别再次打开两个对话框
4. 验证预选功能是否都正常工作

#### 预期结果：
- ✅ 可用商品和排除商品的预选功能互不影响
- ✅ 两个对话框都能正确预选各自的商品

### 测试4：分页情况下的预选

#### 步骤：
1. 在商品选择对话框中切换到第2页或第3页
2. 选择一些商品
3. 确认选择
4. 再次打开对话框
5. 切换到包含之前选择商品的页面
6. 验证预选是否正常

#### 预期结果：
- ✅ 即使商品在不同页面，预选功能也应该正常工作
- ✅ 切换到对应页面时能看到商品被预选

### 测试5：搜索情况下的预选

#### 步骤：
1. 在商品选择对话框中使用搜索功能
2. 选择搜索结果中的商品
3. 确认选择
4. 再次打开对话框
5. 使用相同的搜索条件
6. 验证预选是否正常

#### 预期结果：
- ✅ 搜索条件下选择的商品在相同搜索条件下应该被预选
- ✅ 清空搜索条件后，在完整列表中也应该能看到预选

## 调试信息

### 控制台日志
修复后的代码会在控制台输出以下信息：
```
已选商品数据: [
  {
    id: 123,
    name: "商品名称",
    productSn: "商品货号",
    pic: "图片URL",
    brandName: "品牌名称",
    price: 99.99
  }
]
```

### 检查要点：
1. **ID类型**：确保ID是数字类型，不是字符串
2. **数据完整性**：确保包含所有必要字段
3. **数据一致性**：确保与API返回的商品数据格式一致

## 常见问题排查

### 问题1：预选不工作
**可能原因**：
- ID类型不匹配（字符串 vs 数字）
- 数据结构不完整
- 组件内部时序问题

**排查方法**：
1. 打开浏览器开发者工具
2. 查看控制台日志中的"已选商品数据"
3. 检查ID字段的类型和值
4. 在ProductSelectionDialog组件的preSelectProducts方法中添加断点

### 问题2：部分商品预选，部分不预选
**可能原因**：
- 商品数据不一致
- 分页导致的问题

**排查方法**：
1. 检查未预选商品的数据格式
2. 确认商品是否在当前页面
3. 检查搜索条件是否影响显示

### 问题3：预选后无法取消选择
**可能原因**：
- 组件状态管理问题
- 事件处理问题

**排查方法**：
1. 检查组件的selection-change事件
2. 验证selectedItems状态更新

## 验收标准

### 基本功能
- ✅ 商品选择后能正确显示在表格中
- ✅ 再次打开对话框时已选商品被预选
- ✅ 可以在预选基础上修改选择
- ✅ 排除商品的预选功能正常

### 边界情况
- ✅ 分页情况下预选正常
- ✅ 搜索情况下预选正常
- ✅ 大量商品情况下性能正常
- ✅ 混合操作情况下功能正常

### 用户体验
- ✅ 操作流畅，无明显延迟
- ✅ 预选状态清晰可见
- ✅ 符合用户操作习惯

## 技术细节

### 修复要点
1. **ID类型转换**：`parseInt(item.productId)` 确保ID为数字
2. **数据结构完整**：包含pic、brandName、price等字段
3. **容错处理**：使用 `|| ''` 和 `|| 0` 提供默认值
4. **调试支持**：添加console.log帮助排查问题

### 关键代码
```javascript
// 确保数据格式正确
this.selectedProductsForDialog = this.coupon.productRelationList.map(item => {
  const productId = item.productId;
  return {
    id: typeof productId === 'string' ? parseInt(productId) : productId,
    name: item.productName,
    productSn: item.productSn || '',
    pic: item.pic || '',
    brandName: item.brandName || '',
    price: item.price || 0
  };
});
```

通过这些修复，商品预选功能应该能够正常工作，为用户提供更好的操作体验。
