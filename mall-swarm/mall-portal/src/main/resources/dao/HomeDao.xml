<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.macro.mall.portal.dao.HomeDao">
    <resultMap id="flashPromotionProduct" type="com.macro.mall.portal.domain.FlashPromotionProduct"
               extends="com.macro.mall.mapper.PmsProductMapper.BaseResultMap">
        <result column="flash_promotion_price" property="flashPromotionPrice"/>
        <result column="flash_promotion_count" property="flashPromotionCount"/>
        <result column="flash_promotion_limit" property="flashPromotionLimit"/>
    </resultMap>

    <resultMap id="newProductResultMap" type="com.macro.mall.portal.domain.NewProductDTO">
        <id column="id" property="id"/>
        <result column="product_id" property="productId"/>
        <result column="product_name" property="productName"/>
        <result column="recommend_status" property="recommendStatus"/>
        <result column="sort" property="sort"/>
        <result column="cover" property="cover"/>
        <result column="price" property="price"/>
        <result column="pic" property="pic"/>
        <result column="new_status" property="newStatus"/>
        <result column="p_recommend_status" property="productRecommandStatus"/>
        <result column="product_category_id" property="productCategoryId"/>
        <result column="product_category_name" property="productCategoryName"/>
        <result column="salesCount" property="salesCount"/>
    </resultMap>

    <resultMap id="productListResultMap" type="com.macro.mall.portal.domain.ProductListDTO">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="pic" property="pic"/>
        <result column="sale" property="sale"/>
        <result column="price" property="price"/>
        <result column="stock" property="stock"/>
    </resultMap>



    <select id="getRecommendBrandList" resultMap="com.macro.mall.mapper.PmsBrandMapper.BaseResultMap">
        SELECT b.*
        FROM sms_home_brand hb
                 LEFT JOIN pms_brand b ON hb.brand_id = b.id
        WHERE hb.recommend_status = 1
          AND b.show_status = 1
        ORDER BY hb.sort DESC
            LIMIT #{offset}, #{limit}
    </select>

    <select id="getFlashProductList" resultMap="flashPromotionProduct">
        SELECT pr.flash_promotion_price,
               pr.flash_promotion_count,
               pr.flash_promotion_limit,
               p.*
        FROM sms_flash_promotion_product_relation pr
                 LEFT JOIN pms_product p ON pr.product_id = p.id
        WHERE pr.flash_promotion_id = #{flashPromotionId}
          AND pr.flash_promotion_session_id = #{sessionId}
    </select>

    <select id="getNewProductList" resultMap="newProductResultMap">
        SELECT
            hp.*,
            p.price,
            p.pic,
            p.new_status,
            p.recommand_status as p_recommend_status,
            IFNULL(p.sale, 0) as salesCount,
            -- 递归查找一级分类
            CASE
                WHEN c1.parent_id = 0 THEN c1.id
                WHEN c2.parent_id = 0 THEN c2.id
                WHEN c3.parent_id = 0 THEN c3.id
                ELSE c1.id
            END AS product_category_id,
            CASE
                WHEN c1.parent_id = 0 THEN c1.name
                WHEN c2.parent_id = 0 THEN c2.name
                WHEN c3.parent_id = 0 THEN c3.name
                ELSE c1.name
            END AS product_category_name
        FROM sms_home_new_product hp
        LEFT JOIN pms_product p ON hp.product_id = p.id
        LEFT JOIN pms_product_category c1 ON p.product_category_id = c1.id
        LEFT JOIN pms_product_category c2 ON c1.parent_id = c2.id
        LEFT JOIN pms_product_category c3 ON c2.parent_id = c3.id
        WHERE hp.recommend_status = 1
          AND p.publish_status = 1
          <choose>
              <when test="schoolId != null">
                  AND hp.school_id = #{schoolId}
              </when>
              <otherwise>
                  AND hp.school_id IS NULL
              </otherwise>
          </choose>
        ORDER BY hp.sort DESC
        LIMIT #{offset}, #{limit};
    </select>

    <!-- 获取热门商品列表 - 不带学校ID过滤 -->
    <select id="getHotProductList" resultMap="com.macro.mall.mapper.SmsHomeRecommendProductMapper.BaseResultMap">
        SELECT hp.*
        FROM sms_home_recommend_product hp
                 LEFT JOIN pms_product p ON hp.product_id = p.id
        WHERE hp.recommend_status = 1
          AND p.publish_status = 1
          AND hp.school_id IS NULL
        ORDER BY hp.sort DESC
            LIMIT #{offset}, #{limit};
    </select>

    <!-- 获取热门商品列表 - 带学校ID过滤 -->
    <select id="getHotProductListBySchool" resultMap="com.macro.mall.mapper.SmsHomeRecommendProductMapper.BaseResultMap">
        SELECT hp.*
        FROM sms_home_recommend_product hp
                 LEFT JOIN pms_product p ON hp.product_id = p.id
        WHERE hp.recommend_status = 1
          AND p.publish_status = 1
          AND hp.school_id = #{schoolId}
        ORDER BY hp.sort DESC
            LIMIT #{offset}, #{limit};
    </select>

    <select id="getHotProductListWithPrice" resultType="java.util.HashMap">
        SELECT hp.id,
               hp.product_id as productId,
               hp.product_name as productName,
               hp.recommend_status as recommendStatus,
               hp.sort,
               hp.cover,
               p.price,
               IFNULL(p.sale, 0) as salesCount
        FROM sms_home_recommend_product hp
                 LEFT JOIN pms_product p ON hp.product_id = p.id
        WHERE hp.recommend_status = 1
          AND p.publish_status = 1
          <choose>
              <when test="schoolId != null">
                  AND hp.school_id = #{schoolId}
              </when>
              <otherwise>
                  AND hp.school_id IS NULL
              </otherwise>
          </choose>
        ORDER BY hp.sort DESC
            LIMIT #{offset}, #{limit};
    </select>

    <select id="getRecommendSubjectList" resultMap="com.macro.mall.mapper.CmsSubjectMapper.BaseResultMap">
        SELECT s.*
        FROM sms_home_recommend_subject hs
                 LEFT JOIN cms_subject s ON hs.subject_id = s.id
        WHERE hs.recommend_status = 1
          AND s.show_status = 1
        ORDER BY hs.sort DESC
            LIMIT #{offset}, #{limit};
    </select>
    <select id="selectRecommendSubjectList"
            resultMap="com.macro.mall.mapper.SmsHomeRecommendSubjectMapper.BaseResultMap">
        SELECT hs.*
        FROM sms_home_recommend_subject hs
                 LEFT JOIN
             cms_subject s
             ON
                 hs.subject_id = s.id
        WHERE hs.recommend_status = 1
          AND s.show_status = 1
        ORDER BY hs.sort DESC
            LIMIT #{offset}, #{limit};
    </select>
    <select id="getTraceabilityListTrace" resultMap="com.macro.mall.mapper.CmsTraceabilityListMapper.BaseResultMap">
        SELECT *
        FROM cms_traceability_list
        WHERE category = '精彩濠江'
        ORDER BY create_time DESC
            LIMIT #{offset}, #{limit};
    </select>
    <!-- 根据专题ID获取关联的商品ID -->
    <select id="getProductIdsBySubjectId" resultType="java.lang.Long">
        SELECT product_id
        FROM cms_subject_product_relation
        WHERE subject_id = #{subjectId}
    </select>
    <!-- 根据商品ID列表查询商品详细信息 -->
    <select id="selectByIds" resultMap="com.macro.mall.mapper.PmsProductMapper.BaseResultMap">
        SELECT *
        FROM pms_product
        WHERE delete_status != 1
        AND id IN
        <foreach item="id" collection="ids" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
    
    <!-- 获取本地活动推荐 -->
    <select id="getActivityList" resultMap="com.macro.mall.mapper.CmsActivityMapper.BaseResultMap">
        SELECT *
        FROM cms_activity
        WHERE status = 1
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 获取本地好物推荐 -->
    <select id="getLocalGoodsList" resultMap="com.macro.mall.mapper.CmsLocalGoodsMapper.BaseResultMap">
        SELECT *
        FROM cms_local_goods
        WHERE status = 1
        ORDER BY create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 获取精彩濠江推荐 -->
    <select id="getWonderfulMacauList" resultMap="com.macro.mall.mapper.CmsWonderfulMacauMapper.BaseResultMap">
        SELECT *
        FROM cms_wonderful_macau
        WHERE status = 1
        ORDER BY 
            is_top DESC,
            sort DESC,
            create_time DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- 获取百大主理人推荐 -->
    <select id="getPrincipalPersonList" resultMap="com.macro.mall.mapper.CmsPrincipalPersonMapper.BaseResultMap">
        SELECT *
        FROM cms_principal_person
        WHERE status = 1
        ORDER BY 
            is_recommend DESC,
            sort DESC,
            create_time DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 按销量分页获取商品列表 -->
    <select id="getProductListBySales" resultMap="productListResultMap">
        SELECT
            p.id,
            p.name,
            p.pic,
            IFNULL(p.sale, 0) as sale,
            p.price,
            IFNULL((SELECT SUM(IFNULL(sku.stock, 0)) FROM pms_sku_stock sku WHERE sku.product_id = p.id), 0) as stock
        FROM pms_product p
        <if test="schoolId != null">
            INNER JOIN pms_product_school_relation psr ON p.id = psr.product_id
        </if>
        WHERE p.delete_status = 0
          AND p.publish_status = 1
          <if test="schoolId != null">
              AND psr.school_id = #{schoolId}
          </if>
        ORDER BY p.sale DESC, p.id DESC
        LIMIT #{offset}, #{limit}
    </select>
</mapper>