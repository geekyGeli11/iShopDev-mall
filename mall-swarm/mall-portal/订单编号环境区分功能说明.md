# 订单编号环境区分功能说明

## 功能概述

为了区分不同运行环境的订单，对 `generateOrderSn` 方法进行了改进，使其能够根据当前运行环境生成不同格式的订单编号：

- **生产环境（prod）**: 保持原有格式 `GHZ + 日期 + 平台 + 支付方式 + 序号`
- **测试环境（非prod）**: 在最前面增加 `TEST_` 前缀

## 修改内容

### 1. 代码修改

**文件**: `mall-swarm/mall-portal/src/main/java/com/macro/mall/portal/service/impl/OmsPortalOrderServiceImpl.java`

#### 新增配置属性
```java
@Value("${spring.profiles.active:dev}")
private String activeProfile;
```

#### 修改 generateOrderSn 方法
```java
/**
 * 生成订单编号:
 * 正式环境: GHZ+8位日期+2位平台号码+2位支付方式+6位以上自增id
 * 测试环境: TEST_GHZ+8位日期+2位平台号码+2位支付方式+6位以上自增id
 */
private String generateOrderSn(OmsOrder order) {
    StringBuilder sb = new StringBuilder();
    String date = new SimpleDateFormat("yyyyMMdd").format(new Date());
    String key = REDIS_DATABASE+":"+ REDIS_KEY_ORDER_ID + date;
    Long increment = redisService.incr(key, 1);
    
    // 根据环境添加不同的前缀
    if (!"prod".equals(activeProfile)) {
        // 非生产环境（包括dev、test等）都添加TEST_前缀
        sb.append("TEST_");
    }
    
    sb.append("GHZ");
    sb.append(date);
    sb.append(String.format("%02d", order.getSourceType()));
    sb.append(String.format("%02d", order.getPayType()));
    String incrementStr = increment.toString();
    if (incrementStr.length() <= 6) {
        sb.append(String.format("%06d", increment));
    } else {
        sb.append(incrementStr);
    }
    return sb.toString();
}
```

### 2. 环境判断逻辑

- **生产环境**: `spring.profiles.active=prod` 时，订单编号不添加前缀
- **测试环境**: 其他所有环境（dev、test、staging等）都添加 `TEST_` 前缀
- **安全默认**: 当环境配置为空或未配置时，默认添加 `TEST_` 前缀

## 订单编号格式

### 生产环境格式
```
GHZ + YYYYMMDD + PP + TT + NNNNNN
```

### 测试环境格式
```
TEST_GHZ + YYYYMMDD + PP + TT + NNNNNN
```

**格式说明**:
- `GHZ`: 固定前缀（广恒州商城）
- `YYYYMMDD`: 8位日期
- `PP`: 2位平台号码（01=PC端, 02=移动端, 03=小程序）
- `TT`: 2位支付方式（01=微信, 02=支付宝, 03=银联）
- `NNNNNN`: 6位以上自增序号

## 示例

### 不同环境的订单编号示例

| 环境 | 配置值 | 订单编号示例 | 说明 |
|------|--------|-------------|------|
| 生产环境 | prod | `GHZ202509090101000001` | 无前缀 |
| 开发环境 | dev | `TEST_GHZ202509090101000002` | 有TEST_前缀 |
| 测试环境 | test | `TEST_GHZ202509090101000003` | 有TEST_前缀 |
| 预发布环境 | staging | `TEST_GHZ202509090101000004` | 有TEST_前缀 |
| 未配置环境 | null | `TEST_GHZ202509090101000005` | 有TEST_前缀（安全默认） |

### 不同平台和支付方式示例

| 平台 | 支付方式 | 订单编号示例（开发环境） |
|------|----------|------------------------|
| PC端 | 微信支付 | `TEST_GHZ202509090101000006` |
| 移动端 | 支付宝 | `TEST_GHZ202509090202000007` |
| 小程序 | 银联支付 | `TEST_GHZ202509090303000008` |

## 测试验证

### 单元测试

创建了完整的单元测试 `OmsPortalOrderServiceTest.java`，包含以下测试用例：

1. **testGenerateOrderSnInDevEnvironment**: 测试开发环境订单编号生成
2. **testGenerateOrderSnInProdEnvironment**: 测试生产环境订单编号生成
3. **testGenerateOrderSnInTestEnvironment**: 测试测试环境订单编号生成
4. **testOrderSnUniqueness**: 测试订单编号唯一性
5. **testGenerateOrderSnWithNullProfile**: 测试空环境配置

### 演示程序

创建了演示程序 `OrderSnGeneratorDemo.java`，展示不同环境和配置下的订单编号生成效果。

## 部署配置

### 环境配置

确保在不同环境的配置文件中正确设置 `spring.profiles.active`：

- **生产环境**: `spring.profiles.active=prod`
- **开发环境**: `spring.profiles.active=dev`
- **测试环境**: `spring.profiles.active=test`

### Docker 部署

在 Docker 部署时，通过环境变量设置：
```bash
docker run -e "spring.profiles.active=prod" ...
```

### Kubernetes 部署

在 K8s 配置中设置环境变量：
```yaml
env:
  - name: spring.profiles.active
    value: prod
```

## 优势

1. **环境隔离**: 通过订单编号前缀可以快速识别订单来源环境
2. **安全性**: 避免测试数据与生产数据混淆
3. **可追溯性**: 便于问题排查和数据分析
4. **向后兼容**: 生产环境保持原有格式不变
5. **灵活配置**: 基于 Spring Profile 配置，易于管理

## 注意事项

1. **环境配置**: 确保各环境正确配置 `spring.profiles.active`
2. **数据库隔离**: 建议不同环境使用不同的数据库
3. **监控告警**: 可基于订单编号前缀设置监控规则
4. **文档更新**: 相关接口文档需要更新订单编号格式说明

## 测试结果

所有单元测试通过，功能验证正常：
- ✅ 生产环境订单编号无TEST_前缀
- ✅ 测试环境订单编号有TEST_前缀
- ✅ 订单编号唯一性保证
- ✅ 环境配置缺失时安全默认
- ✅ 不同平台和支付方式正确编码
