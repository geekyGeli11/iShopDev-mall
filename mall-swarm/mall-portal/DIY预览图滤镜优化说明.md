# DIYé¢„è§ˆå›¾æ»¤é•œä¼˜åŒ–è¯´æ˜

## ğŸ“‹ ä¿®æ”¹æ¦‚è¿°

æœ¬æ¬¡ä¿®æ”¹ä¼˜åŒ–äº† PortalDiyController ä¸­"ç”ŸæˆDIYé¢„è§ˆå›¾"æ¥å£çš„å›¾åƒåˆæˆé€»è¾‘ï¼Œé€šè¿‡æ·»åŠ æ»¤é•œæ•ˆæœä½¿æµ·æŠ¥å›¾æ›´è‡ªç„¶åœ°èåˆåˆ°å•†å“å›¾ä¸Šï¼Œå¤§å¹…æå‡è§†è§‰çœŸå®æ„Ÿã€‚

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

**ä¿®æ”¹å‰é—®é¢˜ï¼š**
- è®¾è®¡å›¾å’Œåº•å›¾ç®€å•æ‹¼æ¥ï¼Œè§†è§‰æ•ˆæœç”Ÿç¡¬
- ç¼ºä¹çœŸå®æ„Ÿï¼Œçœ‹èµ·æ¥åƒ"è´´çº¸"æ•ˆæœ

**ä¿®æ”¹åæ•ˆæœï¼š**
- è¾¹ç¼˜è‡ªç„¶èåˆï¼Œæ— æ˜æ˜¾æ‹¼æ¥ç—•è¿¹
- äº®åº¦å¯¹æ¯”åº¦åè°ƒï¼Œä¸ç¯å¢ƒèä¸ºä¸€ä½“
- æ·»åŠ é˜´å½±æ•ˆæœï¼Œå¢å¼ºç«‹ä½“æ„Ÿ
- é¢œè‰²åè°ƒç»Ÿä¸€ï¼Œæ•´ä½“å’Œè°
- ç¯å¢ƒå…‰åå°„ï¼Œæå‡çœŸå®æ„Ÿ

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

### 1. æ–°å¢æ–‡ä»¶

#### `ImageFilterUtil.java`
**è·¯å¾„ï¼š** `mall-swarm/mall-portal/src/main/java/com/macro/mall/portal/util/ImageFilterUtil.java`

**åŠŸèƒ½ï¼š** å›¾åƒæ»¤é•œå·¥å…·ç±»ï¼Œæä¾›å„ç§å›¾åƒå¤„ç†æ»¤é•œæ•ˆæœ

**æ ¸å¿ƒæ–¹æ³•ï¼š**

```java
public static BufferedImage applyPosterFilter(
    BufferedImage baseImage,    // åº•å›¾ï¼ˆå•†å“å›¾ï¼‰
    BufferedImage posterImage,  // æµ·æŠ¥å›¾ï¼ˆè®¾è®¡å›¾ï¼‰
    int x,                      // æµ·æŠ¥åœ¨åº•å›¾ä¸Šçš„Xåæ ‡
    int y                       // æµ·æŠ¥åœ¨åº•å›¾ä¸Šçš„Yåæ ‡
)
```

**å®ç°çš„æ»¤é•œæ•ˆæœï¼š**

1. **è¾¹ç¼˜èåˆï¼ˆEdge Blendingï¼‰**
   - å¯¹æµ·æŠ¥è¾¹ç¼˜è¿›è¡Œé«˜æ–¯æ¨¡ç³Šå¤„ç†
   - åˆ›å»ºè¾¹ç¼˜è’™ç‰ˆï¼Œä¸­å¿ƒåŒºåŸŸä¿æŒæ¸…æ™°ï¼Œè¾¹ç¼˜æ¸å˜æ¨¡ç³Š
   - æ¶ˆé™¤ç”Ÿç¡¬çš„æ‹¼æ¥è¾¹ç•Œ

2. **äº®åº¦å¯¹æ¯”åº¦è°ƒæ•´ï¼ˆBrightness & Contrast Adjustmentï¼‰**
   - å¯¹æ¯”åº¦ç³»æ•°ï¼š0.95ï¼ˆé™ä½5%ï¼‰
   - äº®åº¦è°ƒæ•´ï¼š-5ï¼ˆé™ä½5ä¸ªäº®åº¦çº§åˆ«ï¼‰
   - ä½¿æµ·æŠ¥ä¸ç¯å¢ƒå…‰ç…§åè°ƒ

3. **é˜´å½±æ•ˆæœï¼ˆShadow Effectï¼‰**
   - åœ¨æµ·æŠ¥å‘¨å›´æ·»åŠ è½»å¾®é˜´å½±
   - é˜´å½±å¼ºåº¦ï¼š8%é€æ˜åº¦
   - å¤šå±‚æ¸å˜å®ç°æ¨¡ç³Šæ•ˆæœ
   - å¢å¼ºç«‹ä½“æ„Ÿå’ŒçœŸå®æ„Ÿ

4. **é¢œè‰²åè°ƒï¼ˆColor Harmonyï¼‰**
   - RGBè½¬HSVè‰²å½©ç©ºé—´
   - é¥±å’Œåº¦è°ƒæ•´ï¼š0.98ï¼ˆé™ä½2%ï¼‰
   - ä½¿æµ·æŠ¥é¢œè‰²èå…¥æ•´ä½“ç¯å¢ƒ

5. **ç¯å¢ƒå…‰åå°„ï¼ˆEnvironment Reflectionï¼‰**
   - åœ¨æµ·æŠ¥åŒºåŸŸæ·»åŠ è½»å¾®ç™½è‰²å åŠ 
   - åå°„å¼ºåº¦ï¼š3%
   - æ¨¡æ‹ŸçœŸå®ç¯å¢ƒå…‰åå°„æ•ˆæœ

**è¾…åŠ©æ–¹æ³•ï¼š**
- `applyEdgeBlending()` - è¾¹ç¼˜èåˆ
- `createEdgeMask()` - åˆ›å»ºè¾¹ç¼˜è’™ç‰ˆ
- `applyGaussianBlur()` - é«˜æ–¯æ¨¡ç³Š
- `createGaussianKernel()` - åˆ›å»ºé«˜æ–¯æ ¸
- `adjustBrightnessContrast()` - äº®åº¦å¯¹æ¯”åº¦è°ƒæ•´
- `applyShadowEffect()` - é˜´å½±æ•ˆæœ
- `adjustSaturation()` - é¥±å’Œåº¦è°ƒæ•´ï¼ˆHSVï¼‰
- `applyEnvironmentReflection()` - ç¯å¢ƒå…‰åå°„
- `rgbToHsv()` - RGBè½¬HSVè‰²å½©ç©ºé—´
- `hsvToRgb()` - HSVè½¬RGBè‰²å½©ç©ºé—´

### 2. ä¿®æ”¹æ–‡ä»¶

#### `PortalDiyServiceImpl.java`
**è·¯å¾„ï¼š** `mall-swarm/mall-portal/src/main/java/com/macro/mall/portal/service/impl/PortalDiyServiceImpl.java`

**ä¿®æ”¹å†…å®¹ï¼š**

1. **æ·»åŠ å¯¼å…¥è¯­å¥**
```java
import com.macro.mall.portal.util.ImageFilterUtil;
```

2. **é‡æ„ `compositeImageToCustomArea()` æ–¹æ³•**

**ä¿®æ”¹å‰é€»è¾‘ï¼š**
```java
// ç›´æ¥å°†è®¾è®¡å›¾ç»˜åˆ¶åˆ°åº•å›¾ä¸Š
g2d.drawImage(maskedImage, clippedX, clippedY, null);
```

**ä¿®æ”¹åé€»è¾‘ï¼š**
```java
// 1. å…ˆè¿›è¡Œå½¢çŠ¶è£å‰ª
BufferedImage imageToComposite = applyShapeMask(...);

// 2. åº”ç”¨æ»¤é•œæ•ˆæœ
BufferedImage resultImage = ImageFilterUtil.applyPosterFilter(
    baseImage,          // åº•å›¾
    imageToComposite,   // è£å‰ªåçš„è®¾è®¡å›¾
    clippedX,           // Xåæ ‡
    clippedY            // Yåæ ‡
);
```

3. **æ–°å¢è¾…åŠ©æ–¹æ³•**
```java
private BufferedImage cropToRectangle(BufferedImage image, int width, int height)
```
ç”¨äºçŸ©å½¢è£å‰ªï¼Œé…åˆæ»¤é•œä½¿ç”¨ã€‚

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### é«˜æ–¯æ¨¡ç³Šç®—æ³•
ä½¿ç”¨å·ç§¯æ ¸ï¼ˆConvolution Kernelï¼‰å®ç°ï¼š
- æ ¸å¤§å°ï¼šradius * 2 + 1
- é«˜æ–¯å‡½æ•°ï¼šexp(-(dxÂ² + dyÂ²) / (2ÏƒÂ²))
- Ïƒ = size / 3.0
- å½’ä¸€åŒ–å¤„ç†ç¡®ä¿äº®åº¦ä¸å˜

### HSVè‰²å½©ç©ºé—´è½¬æ¢
- **H (Hue)**: è‰²ç›¸ï¼Œ0-360åº¦
- **S (Saturation)**: é¥±å’Œåº¦ï¼Œ0-1
- **V (Value)**: æ˜åº¦ï¼Œ0-1

è½¬æ¢å…¬å¼ï¼š
```
RGB â†’ HSV:
  max = max(R, G, B)
  min = min(R, G, B)
  delta = max - min
  V = max
  S = delta / max
  H = æ ¹æ®æœ€å¤§å€¼è®¡ç®—

HSV â†’ RGB:
  ä½¿ç”¨å…­è¾¹å½¢æ¨¡å‹è½¬æ¢
```

### è¾¹ç¼˜è’™ç‰ˆç®—æ³•
```
distToEdge = min(x, width-x, y, height-y)
if distToEdge < edgeWidth:
    mask = distToEdge / edgeWidth
else:
    mask = 1.0
```

## ğŸ“Š æ€§èƒ½è€ƒè™‘

1. **å›¾åƒå¤„ç†ä¼˜åŒ–**
   - ä½¿ç”¨ BufferedImage.TYPE_INT_ARGB æ”¯æŒé€æ˜åº¦
   - é«˜è´¨é‡æ¸²æŸ“æç¤ºï¼ˆRenderingHintsï¼‰
   - é¿å…é‡å¤åˆ›å»ºå›¾åƒå¯¹è±¡

2. **å¼‚å¸¸å¤„ç†**
   - æ»¤é•œå¤±è´¥æ—¶é™çº§åˆ°ç®€å•åˆæˆ
   - ä¿è¯æ¥å£ç¨³å®šæ€§

3. **æ—¥å¿—è®°å½•**
   - å…³é”®æ­¥éª¤æ·»åŠ æ—¥å¿—
   - ä¾¿äºè°ƒè¯•å’Œæ€§èƒ½åˆ†æ

## ğŸ¨ è§†è§‰æ•ˆæœå¯¹æ¯”

### ä¿®æ”¹å‰
- âŒ è®¾è®¡å›¾ç›´æ¥è¦†ç›–åœ¨åº•å›¾ä¸Š
- âŒ è¾¹ç¼˜ç”Ÿç¡¬ï¼Œæœ‰æ˜æ˜¾æ‹¼æ¥ç—•è¿¹
- âŒ äº®åº¦å¯¹æ¯”åº¦ä¸åè°ƒ
- âŒ ç¼ºä¹ç«‹ä½“æ„Ÿ
- âŒ é¢œè‰²çªå…€

### ä¿®æ”¹å
- âœ… è¾¹ç¼˜è‡ªç„¶èåˆ
- âœ… äº®åº¦å¯¹æ¯”åº¦åè°ƒ
- âœ… æ·»åŠ é˜´å½±ï¼Œç«‹ä½“æ„Ÿå¼º
- âœ… é¢œè‰²åè°ƒç»Ÿä¸€
- âœ… ç¯å¢ƒå…‰åå°„ï¼ŒçœŸå®æ„Ÿå¼º

## ğŸ”„ æ¥å£å…¼å®¹æ€§

**å®Œå…¨å…¼å®¹ï¼**
- âœ… æ¥å£ç­¾åæœªæ”¹å˜
- âœ… è¾“å…¥å‚æ•°æœªæ”¹å˜
- âœ… è¾“å‡ºæ ¼å¼æœªæ”¹å˜
- âœ… åªä¿®æ”¹å†…éƒ¨å›¾åƒå¤„ç†é€»è¾‘
- âœ… å‰ç«¯æ— éœ€ä»»ä½•ä¿®æ”¹

## ğŸ“ ä½¿ç”¨è¯´æ˜

### æ¥å£è°ƒç”¨
```
POST /diy/preview/generate
```

**è¯·æ±‚å‚æ•°ï¼š** DiyDesignParamï¼ˆä¸ä¹‹å‰å®Œå…¨ç›¸åŒï¼‰

**å“åº”ç»“æœï¼š** DiyPreviewResultï¼ˆä¸ä¹‹å‰å®Œå…¨ç›¸åŒï¼‰

### å†…éƒ¨æµç¨‹
1. è§£æè®¾è®¡æ•°æ®
2. åŠ è½½åº•å›¾å’Œè®¾è®¡å…ƒç´ 
3. ç”Ÿæˆç”¨æˆ·è®¾è®¡å›¾
4. **æ™ºèƒ½ç¼©æ”¾è®¾è®¡å›¾**
5. **åº”ç”¨å½¢çŠ¶è£å‰ª**
6. **åº”ç”¨æ»¤é•œæ•ˆæœ** â­ æ–°å¢
7. ä¸Šä¼ åˆ°OSS
8. è¿”å›é¢„è§ˆå›¾URL

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•åœºæ™¯
1. **åŸºç¡€åŠŸèƒ½æµ‹è¯•**
   - ç”Ÿæˆå•é¢é¢„è§ˆå›¾
   - ç”Ÿæˆå¤šé¢é¢„è§ˆå›¾
   - ä¸åŒå°ºå¯¸çš„è®¾è®¡å›¾

2. **æ»¤é•œæ•ˆæœæµ‹è¯•**
   - è¾¹ç¼˜èåˆæ•ˆæœ
   - é˜´å½±æ•ˆæœ
   - é¢œè‰²åè°ƒæ•ˆæœ

3. **æ€§èƒ½æµ‹è¯•**
   - å¤§å°ºå¯¸å›¾ç‰‡å¤„ç†
   - å¹¶å‘è¯·æ±‚å¤„ç†
   - å“åº”æ—¶é—´æµ‹è¯•

4. **å¼‚å¸¸æµ‹è¯•**
   - æ— æ•ˆå›¾ç‰‡URL
   - è¶…å¤§å›¾ç‰‡
   - ç½‘ç»œå¼‚å¸¸

### éªŒè¯è¦ç‚¹
- âœ… é¢„è§ˆå›¾ç”ŸæˆæˆåŠŸ
- âœ… è§†è§‰æ•ˆæœè‡ªç„¶çœŸå®
- âœ… è¾¹ç¼˜æ— æ˜æ˜¾æ‹¼æ¥ç—•è¿¹
- âœ… é˜´å½±æ•ˆæœæ˜æ˜¾
- âœ… é¢œè‰²åè°ƒç»Ÿä¸€
- âœ… æ¥å£å“åº”æ—¶é—´å¯æ¥å—ï¼ˆå»ºè®®<3ç§’ï¼‰

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **æ€§èƒ½ä¼˜åŒ–**
   - è€ƒè™‘ä½¿ç”¨ GPU åŠ é€Ÿå›¾åƒå¤„ç†
   - æ·»åŠ å›¾åƒå¤„ç†ç»“æœç¼“å­˜
   - å¼‚æ­¥å¤„ç†å¤§å›¾ç‰‡

2. **æ•ˆæœä¼˜åŒ–**
   - æ ¹æ®åº•å›¾é¢œè‰²åŠ¨æ€è°ƒæ•´æ»¤é•œå‚æ•°
   - æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ»¤é•œå¼ºåº¦
   - æ·»åŠ æ›´å¤šæ»¤é•œæ•ˆæœï¼ˆå¦‚æ™¯æ·±ã€å…‰æ™•ç­‰ï¼‰

3. **åŠŸèƒ½æ‰©å±•**
   - æ”¯æŒæ‰¹é‡é¢„è§ˆå›¾ç”Ÿæˆ
   - æ”¯æŒè§†é¢‘é¢„è§ˆ
   - æ”¯æŒ3Dé¢„è§ˆ

## ğŸ“š å‚è€ƒèµ„æ–™

- Java 2D Graphics API
- å›¾åƒå¤„ç†ç®—æ³•ï¼šé«˜æ–¯æ¨¡ç³Šã€è‰²å½©ç©ºé—´è½¬æ¢
- Python OpenCV å®ç°å‚è€ƒ

## ğŸ‘¨â€ğŸ’» å¼€å‘è€…ä¿¡æ¯

- **ä¿®æ”¹æ—¥æœŸï¼š** 2025-01-27
- **ä¿®æ”¹äººï¼š** macro
- **ç‰ˆæœ¬ï¼š** v1.0

