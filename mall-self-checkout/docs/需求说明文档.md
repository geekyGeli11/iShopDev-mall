# 广横走-自助收银系统（mall-self-checkout）

## 第一章 系统描述

### 1.1 系统价值

广横走自助收银系统（mall-self-checkout）是一套面向线下门店的自助结账/自助点餐/自助验货终端解决方案。系统整合商品扫码、购物车管理、订单支付、发票/小票打印、设备管理与远程运维功能，帮助门店实现无人值守或半自助的收银场景，提高结账效率、降低人力成本并改善用户体验。

系统支持桌面（Electron）、Android（Capacitor）等多终端运行，具备离线缓存与网络同步能力，适配不同硬件（扫描枪、打印机、支付终端）。

### 1.2 系统技术架构

系统采用以下核心技术：

| 技术/平台   | 说明                             | 用途/作用                         |
|-------------|----------------------------------|----------------------------------|
| Vue / Vue3  | 前端框架                         | 视图层与业务逻辑                 |
| Capacitor   | 原生桥接（Android/iOS）         | 调用原生能力（安装APK、设备API） |
| Electron    | 桌面端容器                       | 打包桌面应用                      |
| WebView     | 嵌入式浏览器（Android）         | 在原生容器中运行前端页面         |
| HTTP / REST | 与后端（mall-portal/mall-admin） | 数据同步、订单上报、设备心跳     |
| 本地存储    | SQLite/IndexedDB/文件存储        | 离线订单、缓存、日志             |

### 1.3 系统功能描述

系统主要包含以下核心功能模块：

1. 设备注册与心跳：设备入网登记、定时心跳与状态上报
2. 商品扫码与识别：扫码枪/摄像头扫码识别商品或手工输入条码
3. 购物车与订单：商品加入购物车、优惠/折扣、订单生成
4. 支付与结算：支持微信、支付宝、会员积分与现金补录
5. 小票/发票打印：热敏打印机、发票设备驱动与模板
6. 离线能力：断网下下单缓存与事后同步
7. 设备管理与升级：远程配置、版本管理、APK安装/更新
8. 日志与监控：运行日志、错误上报、操作审计

## 第二章 系统模块介绍

### 2.1 设备注册与心跳

功能简介：设备首次上线向后台注册并定期发送心跳，上报版本、硬件状态、网络状态等。

使用路径：
1. 设备开机后自动向后端注册
2. 定时发送心跳信息
3. 后端下发远程配置或升级指令

使用效果：
- 管理端可以查看设备在线/离线状态
- 支持远程锁定、重启、升级等运维操作

### 2.2 商品扫码与识别

功能简介：通过条码/二维码识别商品，支持扫描枪、摄像头或手工输入。

使用路径：
1. 顾客/操作员在终端扫描商品条码
2. 系统根据条码查询商品信息并展示
3. 若未识别，可手动搜索或输入商品编码

使用效果：
- 支持条码快速入货到购物车
- 展示商品图片、价格、库存与促销信息
- 支持自定义识别规则与兜底搜索

### 2.3 购物车与订单

功能简介：管理购物车、计算价格、应用优惠并生成订单。

使用路径：
1. 扫描或选择商品后加入购物车
2. 支持修改数量、删除商品、清空购物车
3. 选择优惠券/会员折扣后生成支付订单

使用效果：
- 实时计算小计与总价
- 支持多种促销规则（满减、折扣、积分抵扣）
- 支持订单保存、草单恢复与重打印

### 2.4 支付与结算

功能简介：提供多种支付方式，并保证支付回调与订单一致性。

使用路径：
1. 选择支付方式（微信/支付宝/现金/会员积分）
2. 发起支付并等待第三方返回结果
3. 支付成功后打印小票并关闭订单

使用效果：
- 支持扫码支付（被扫/主扫），并能处理回调重试
- 支持积分抵扣、找零与现金补录
- 支付失败时提供异常处理与人工介入流程

### 2.5 小票/发票打印

功能简介：接入热敏打印机或发票打印机，完成纸质凭证输出。

使用路径：
1. 订单完成后自动触发打印
2. 支持重打印、打印预览与打印设置
3. 发票需与后台发票服务对接并获取发票数据

使用效果：
- 打印模板可配置（门店信息、商品明细、收银员）
- 支持打印状态回写与打印错误告警

### 2.6 离线能力与网络同步

功能简介：终端在断网情况下仍可完成下单并在网络恢复后同步。

使用路径：
1. 断网时本地缓存订单及支付凭证（若能离线支付）
2. 网络恢复时自动或手动同步未上报的订单与日志

使用效果：
- 避免因网络波动影响业务连续性
- 提供冲突检测与重试机制，确保数据一致性

### 2.7 设备管理与升级

功能简介：支持远程下发配置、版本管理与APK更新。

使用路径：
1. 管理端发布新版本或下发配置
2. 设备收到通知后可选择静默更新或提示更新
3. 使用本地APK安装器/Capacitor桥进行安装

使用效果：
- 支持断点下载与重试
- 支持回滚机制与版本切换
- 管理端能查看更新状态与日志

### 2.8 硬件外设对接

功能简介：集成扫描枪、打印机、现金抽屉、刷卡器等硬件。

使用路径：
1. 设备开机自检并初始化外设驱动
2. 收银过程中调用外设（打印、扫码、开钱箱）

使用效果：
- 外设状态上报与故障告警
- 提供外设测试页与手动操作入口

### 2.9 日志与监控

功能简介：收集运行日志、异常堆栈与操作审计，支持导出与上报。

使用路径：
1. 本地记录操作日志与错误日志
2. 定期上传到后端或在联网时同步
3. 管理端查看与检索日志

使用效果：
- 支持按设备、时间范围检索日志
- 支持关键错误告警（如支付失败、打印失败）

### 2.10 管理与运维功能

功能简介：管理端对设备进行分组、配置下发、远程重启与状态监控。

使用路径：
1. 管理端创建设备分组并下发配置
2. 设备接收并应用配置
3. 管理员执行远程运维（锁定、重启、升级）

使用效果：
- 提高运维效率，减少现场人工成本
- 实时掌握设备健康状态与使用统计

## 第三章 项目结构说明

### 3.1 目录结构（示例）

```lua
src -- 源码目录
├── android -- Android 原生/Capacitor 代码
├── electron -- Electron 桌面打包配置
├── plugins -- 原生插件（APK安装、设备驱动）
├── renderer -- 前端页面资源（Vue）
├── assets -- 静态资源
├── utils -- 工具方法（网络、存储、打印）
├── store -- 状态管理
└── dist -- 打包产物
```

### 3.2 开发环境要求

1. Node.js（建议与项目 README 中一致的版本）
2. Android SDK（如需构建 Android 包）
3. Capacitor / Cordova 相关工具
4. Electron 打包工具（如 electron-builder）
5. 本地后端或测试接口（http://localhost:8201/mall-selfcheck 或网关地址）

### 3.3 项目部署说明

1. 本地调试：
   - 安装依赖（npm install / yarn）
   - 启动开发服务器或在 Capacitor/Electron 环境中运行
2. Android 发布：
   - 使用 Capacitor 同步原生工程
   - 在 Android Studio 中构建并签名 APK
3. 桌面发布：
   - 使用 electron-builder 打包为安装包

### 3.4 接口对接说明

1. 开发/测试环境：
   - 默认接口地址：http://localhost:8201/mall-selfcheck
   - 重要接口：设备注册、心跳、下单上报、版本查询、打印日志上报等
2. 生产环境：
   - 使用网关或生产域名
   - 确保接口支持认证、设备鉴权与幂等

## 附录：关键业务契约（建议）

- 设备鉴权：设备应持有唯一 deviceId 与密钥，首次注册完成设备与门店/组织绑定
- 订单上报幂等：每笔订单带唯一 localOrderId，服务端应支持幂等处理
- 日志上报批次：离线时本地批量缓存，网络恢复时按批次同步，避免一次性过大传输
- 升级策略：后台发布版本同时提供降级策略与安装回滚方案

---

文件位置：e:\Java\guanghengzhou-mall\mall-self-checkout\需求说明文档.md
