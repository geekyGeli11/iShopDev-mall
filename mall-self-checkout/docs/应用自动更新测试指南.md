# 应用自动更新测试指南

## 系统架构概述

### 更新流程
1. **版本检查**: mall-self-checkout → mall-selfcheck API
2. **文件下载**: mall-self-checkout → mall-selfcheck API → OSS
3. **权限管理**: PermissionManager处理Android权限
4. **APK安装**: AppInstaller插件执行安装

### API端点
- **版本检查**: `POST /mall-selfcheck/app/version/check`
- **文件下载**: `GET /mall-selfcheck/app/download/{versionId}`

## 测试前准备

### 1. 确保服务运行
```bash
# 启动mall-selfcheck服务
cd mall-swarm
mvn spring-boot:run -pl mall-selfcheck

# 启动mall-self-checkout
cd mall-self-checkout
npm run dev
```

### 2. 检查API配置
在`mall-self-checkout/src/config/env.ts`中确认API地址：
- 开发环境桌面端: `http://localhost:8201/mall-selfcheck`
- 开发环境移动端: `http://10.0.2.2:8201/mall-selfcheck`

### 3. 准备测试APK
在mall-admin-web中上传一个测试APK文件，确保：
- 版本号高于当前应用版本
- 文件上传到OSS成功
- 版本状态为"激活"

## 测试方法

### 方法1: 浏览器开发者工具测试

#### 1. 打开开发者控制台
在mall-self-checkout应用中按F12打开开发者工具

#### 2. 手动触发版本检查
```javascript
// 在控制台执行
window.appUpdateService.manualCheck().then(result => {
  console.log('版本检查结果:', result)
})
```

#### 3. 查看网络请求
在Network标签页中查看：
- `POST /app/version/check` - 版本检查请求
- `GET /app/download/{versionId}` - 文件下载请求

#### 4. 查看日志输出
在Console标签页中查看详细的更新日志

### 方法2: 应用内测试界面

#### 1. 添加测试按钮
在应用界面中添加测试按钮来触发更新检查：

```vue
<template>
  <div class="update-test">
    <el-button @click="checkUpdate" type="primary">检查更新</el-button>
    <el-button @click="downloadUpdate" type="success" :disabled="!hasUpdate">下载更新</el-button>
    <div v-if="updateProgress.status !== 'completed'">
      <p>状态: {{ updateProgress.message }}</p>
      <el-progress :percentage="updateProgress.progress"></el-progress>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { AppUpdateService } from '@/shared/services/AppUpdateService'

const updateService = new AppUpdateService()
const hasUpdate = ref(false)
const updateProgress = ref({ status: 'completed', progress: 0, message: '' })
const latestVersion = ref(null)

const checkUpdate = async () => {
  const result = await updateService.manualCheck()
  if (result) {
    hasUpdate.value = result.hasUpdate
    latestVersion.value = result.latestVersion
    console.log('检查结果:', result)
  }
}

const downloadUpdate = async () => {
  if (latestVersion.value) {
    await updateService.downloadAndInstall(latestVersion.value)
  }
}

// 监听更新进度
updateService.onProgress((progress) => {
  updateProgress.value = progress
})
</script>
```

### 方法3: Android设备真机测试

#### 1. 构建Android APK
```bash
cd mall-self-checkout
npm run build:android
```

#### 2. 安装到设备
```bash
npx cap run android
```

#### 3. 查看原生日志
```bash
npx cap run android --livereload --external
# 或使用Android Studio查看Logcat
```

## 测试场景

### 场景1: 正常更新流程
1. 当前版本: 1.0.0 (versionCode: 1)
2. 服务器版本: 1.1.0 (versionCode: 2)
3. 预期结果: 检测到更新，下载并安装

### 场景2: 强制更新
1. 设置更新类型为"强制更新"
2. 预期结果: 不允许跳过，必须更新

### 场景3: 无更新
1. 当前版本等于或高于服务器版本
2. 预期结果: 提示已是最新版本

### 场景4: 网络异常
1. 断开网络连接
2. 预期结果: 显示网络错误信息

### 场景5: 权限测试
1. 拒绝存储权限
2. 拒绝安装权限
3. 预期结果: 显示权限请求对话框

## 调试技巧

### 1. 查看详细日志
```javascript
// 在控制台查看更新服务状态
console.log(window.appUpdateService.getStatus())

// 查看配置信息
console.log(window.appUpdateService.getConfig())
```

### 2. 模拟不同版本
修改`capacitor.config.ts`中的版本信息：
```typescript
{
  appId: 'com.macro.mall.selfcheckout',
  appName: 'Mall Self Checkout',
  version: '1.0.0', // 修改这里测试不同版本
  build: '1'        // 修改这里测试不同构建号
}
```

### 3. 网络请求调试
在Network标签页中查看：
- 请求URL是否正确
- 请求参数是否完整
- 响应状态码和数据
- 下载进度

### 4. 权限状态检查
```javascript
// 检查权限状态
window.permissionManager.checkAllPermissions().then(status => {
  console.log('权限状态:', status)
})
```

## 常见问题排查

### 1. 版本检查失败
- 检查API服务是否启动
- 确认API地址配置正确
- 查看网络请求是否成功

### 2. 下载失败
- 检查OSS配置是否正确
- 确认文件URL是否有效
- 查看存储权限是否授予

### 3. 安装失败
- 检查安装权限是否授予
- 确认APK文件完整性
- 查看Android系统版本兼容性

### 4. 权限问题
- 在Android设置中手动授予权限
- 检查targetSdkVersion配置
- 查看权限请求流程

## 测试数据示例

### 版本检查请求
```json
{
  "deviceId": "android_device_123",
  "currentVersionCode": 1,
  "currentVersionName": "1.0.0",
  "deviceName": "Test Device",
  "deviceModel": "Android SDK",
  "androidVersion": "11",
  "platform": "android"
}
```

### 版本检查响应
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "hasUpdate": true,
    "forceUpdate": false,
    "latestVersion": {
      "versionId": 1,
      "versionName": "1.1.0",
      "versionCode": 2,
      "apkFileSize": 25600000,
      "apkFileSizeFormatted": "25.6 MB",
      "apkFileMd5": "abc123def456",
      "updateType": 1,
      "updateTypeDesc": "普通更新",
      "updateContent": "修复已知问题，优化用户体验",
      "downloadUrl": "http://localhost:8201/mall-selfcheck/app/download/1",
      "releaseTime": "2025-09-04 19:00:00"
    }
  }
}
```

通过以上测试方法，你可以全面验证应用自动更新功能的各个环节！
