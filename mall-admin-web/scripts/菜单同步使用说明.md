# 菜单和资源同步脚本使用说明

## 问题背景

线上版本的菜单表和资源表数据不完整，导致非admin用户无法访问所有页面或API。需要根据前端实际的路由配置和后端Controller接口，同步完整的菜单和资源数据到数据库。

## 脚本说明

| 脚本 | 作用 |
|------|------|
| `menu_sync.py` | 同步前端路由到菜单表 (ums_menu) |
| `resource_sync.py` | 同步后端API到资源表 (ums_resource) |

## 菜单 vs 资源

- **菜单(Menu)**：控制前端侧边栏显示哪些菜单项，通过 `name` 字段与前端路由匹配
- **资源(Resource)**：控制后端API接口的访问权限，通过 `url` 字段匹配请求路径

## 使用步骤

### 1. 安装依赖
```bash
pip install pymysql
```

2. **配置数据库连接**
脚本中的数据库配置已设置为线上环境：
```python
DB_CONFIG = {
    'host': 'rm-7xvw6f28955onk26duo.mysql.rds.aliyuncs.com',
    'user': 'guanghengzou',
    'password': 'Guanghengzou2025',
    'database': 'guanghengzou-mall',
    'charset': 'utf8mb4'
}
```

### 3. 运行菜单同步脚本
```bash
python menu_sync.py
```

### 4. 运行资源同步脚本
```bash
python resource_sync.py
```

### 脚本功能

**菜单同步 (menu_sync.py)**
- ✅ **安全备份**：同步前可选择备份现有菜单数据
- ✅ **智能同步**：自动识别新增和更新的菜单项
- ✅ **完整覆盖**：包含所有前端路由菜单
- ✅ **废弃清理**：自动删除溯源等废弃菜单
- ✅ **交互确认**：每步操作都有确认提示

**资源同步 (resource_sync.py)**
- ✅ **分类同步**：自动创建缺失的资源分类
- ✅ **智能识别**：根据URL判断资源是否已存在
- ✅ **完整覆盖**：包含所有后端Controller接口
- ✅ **交互菜单**：支持查看、备份、同步等操作

## 最新菜单结构

同步后的完整菜单结构（按前端实际显示顺序）：

```
1. 学校管理 (school)
   └── 学校管理
2. 仪表盘 (home)
   └── 仪表盘
3. 装修 (decorate)
   ├── 主题色搭配
   └── 页面底图装修
4. 自助收银 (selfcheck)
   └── 应用更新管理
5. 设置 (settings)
   ├── 门店地址设置
   ├── 售后原因设置
   ├── 运费模板设置
   ├── 签到设置
   ├── 邀请设置
   ├── 佣金设置
   ├── 提现设置
   └── 充值配置
6. 权限 (ums)
   ├── 员工列表
   ├── 角色列表
   ├── 菜单列表
   └── 资源列表
7. 营销 (sms)
   ├── 限时优惠
   ├── 优惠券
   ├── 积分营销活动
   ├── 品牌推荐
   ├── 热榜推荐
   ├── 爆品榜单
   ├── 专题推荐
   ├── banner列表
   └── 通知弹窗
8. 推广 (promotion)
   ├── 数据统计
   ├── 邀请记录
   ├── 奖励记录
   ├── 提现管理
   ├── 推广大使申请
   └── 推广大使管理
9. 会员 (member)
   ├── 会员列表
   ├── 游客列表
   ├── 充值记录
   ├── 签到记录
   ├── 会员等级管理
   └── 积分换购配置
10. 订单 (oms)
    ├── 订单列表
    ├── DIY订单列表
    └── 退货申请处理
11. DIY管理 (diy)
    ├── 素材分类管理DIY
    ├── DIY素材管理
    ├── 风格模型管理
    └── DIY模板管理
12. 商品 (pms)
    ├── 商品列表
    ├── 商品分类
    ├── 商品类型
    ├── 品牌管理
    ├── 库存管理
    └── 回本分析
```

## 数据库变更

同步后的菜单表包含：
- **父级菜单**：12个主要模块
- **子级菜单**：111个功能页面（新增充值配置）
- **隐藏菜单**：包含添加/编辑等操作页面
- **已删除**：溯源相关的废弃菜单

## 权限控制

同步完成后：
1. **admin用户**：仍然拥有所有权限（代码特殊处理）
2. **普通用户**：需要通过角色分配菜单权限
3. **角色管理**：可以精确控制用户能访问的菜单

## 关于邀请管理

邀请相关功能分布在不同模块下，这是正确的设计：
- **推广模块**：邀请统计、记录等业务功能
- **设置模块**：邀请配置等系统设置
- 这些菜单的路径和归属都是按照业务逻辑正确分类的

## 注意事项

1. **数据库安全**：脚本已配置线上数据库，请谨慎操作
2. **备份重要**：建议同步前先备份数据库
3. **权限分配**：同步后需要重新分配用户角色权限
4. **重复执行**：脚本支持重复执行，是安全的

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查网络连接
   - 确认数据库服务正常

2. **权限不足**
   - 确认数据库用户有足够权限
   - 检查防火墙设置

3. **菜单重复**
   - 脚本会自动处理重复菜单
   - 重复执行是安全的

通过这些脚本，可以快速解决菜单和资源权限不一致的问题，确保所有用户都能根据角色权限正常访问对应的菜单页面和API接口。

## 资源分类说明

| ID | 分类名称 | 说明 |
|----|----------|------|
| 1 | 商品模块 | 商品、品牌、分类、库存等 |
| 2 | 订单模块 | 订单、退货、运费等 |
| 3 | 营销模块 | 优惠券、限时优惠、广告等 |
| 4 | 权限模块 | 用户、角色、菜单、资源等 |
| 5 | 内容模块 | 专题、优选区域等 |
| 6 | 会员模块 | 会员、等级、余额、积分等 |
| 7 | 其他模块 | 文件上传、学校、应用更新等 |
| 8 | DIY模块 | DIY素材、模板、装修等 |
| 9 | 推广模块 | 邀请、提现、推广大使等 |
| 10 | 设置模块 | 签到、充值、客服配置等 |
| 11 | 统计模块 | 首页统计、仪表盘等 |

## 权限分配流程

1. **同步菜单**：运行 `menu_sync.py` 确保菜单表完整
2. **同步资源**：运行 `resource_sync.py` 确保资源表完整
3. **创建角色**：在后台 权限 → 角色列表 创建角色
4. **分配菜单**：给角色分配可访问的菜单
5. **分配资源**：给角色分配可访问的API资源
6. **分配用户**：在 权限 → 员工列表 给用户分配角色

## 超级管理员说明

代码已修改为支持通过角色判断超级管理员：
- 用户名为 `admin`
- 或角色名为 `superadmin` 
- 或角色名为 `超级管理员`

满足以上任一条件的用户，前端会显示所有菜单。
